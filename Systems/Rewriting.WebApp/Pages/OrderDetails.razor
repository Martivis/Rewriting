@page "/order/{orderUid}"

@attribute [Authorize]

@inject OrderService OrderService
@inject OrderOffersService OrderOffersService
@inject ContractService ContractService
@inject ContractResultsService ResultsService
@inject ISnackbar SnackbarService

@if (_orderModel is null)
{
    <MudCard>
        <MudContainer Class="pa-3" MaxWidth="MaxWidth.Medium">
            <MudPaper Class="pa-3 ma-4" Elevation="0">
                <MudGrid Justify="Justify.SpaceBetween">
                    <MudSkeleton Height="100px" Width="550px" />
                    <MudSkeleton Height="50px" Width="100px" />
                </MudGrid>
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudText Typo="Typo.h5">Status</MudText>
                <MudSkeleton Height="50px" Width="150px" />
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudText Typo="Typo.h5">Text</MudText>
                <MudSkeleton Height="150px" Width="100%" />
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudText Typo="Typo.h5">Comment</MudText>
                <MudSkeleton Height="70px" Width="100%" />
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudGrid Justify="Justify.SpaceBetween">
                    <MudPaper Class="pa-3" Elevation="0">
                        <MudText Typo="Typo.h5">Client</MudText>
                        <MudSkeleton Height="50px" Width="150px" />
                    </MudPaper>
                    <MudPaper Class="pa-3" Elevation="0">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" /><MudSkeleton Height="50px" Width="150px" />
                    </MudPaper>
                </MudGrid>
            </MudPaper>
        </MudContainer>

    </MudCard>
}
else
{
    <MudCard>
        <MudContainer Class="pa-3" MaxWidth="MaxWidth.Medium">
            <MudPaper Class="pa-3 ma-4" Elevation="0">
                <MudGrid Justify="Justify.SpaceBetween">
                    <MudText Typo="Typo.h5">@_orderModel.Title</MudText>
                    @if (IsCancelable())
                    {
                        <MudButton Color="Color.Error" OnClick="CancelOrderAsync">Cancel order</MudButton>
                    }
                </MudGrid>
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudText Typo="Typo.h5">Status</MudText>
                <MudText>@_orderModel.Status</MudText>
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudText Typo="Typo.h5">Text</MudText>
                <MudText>@_orderModel.Text</MudText>
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudText Typo="Typo.h5">Comment</MudText>
                <MudText>@_orderModel.Comment</MudText>
            </MudPaper>

            <MudPaper Class="pa-3 ma-2" Elevation="0">
                <MudGrid Justify="Justify.SpaceBetween">
                    <MudPaper Class="pa-3" Elevation="0">
                        <MudText Typo="Typo.h5">Client</MudText>
                        <MudText>@_orderModel.ClientName</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-3" Elevation="0">
                        <MudText><MudIcon Icon="@Icons.Material.Filled.CalendarMonth" /> @_orderModel.PublishDate</MudText>
                    </MudPaper>
                </MudGrid>
            </MudPaper>

            @if (_orderModel.ContractorUid is not null)
            {
                <MudPaper Class="pa-3 ma-2" Elevation="0">
                    <MudText Typo="Typo.h5">Contractor</MudText>
                    <MudText>@_orderModel.ContractorName</MudText>
                    <MudText><MudIcon Icon="@Icons.Material.Filled.CalendarMonth" /> @_orderModel.ContractPublishDate</MudText>
                </MudPaper>
            }
            else
            {
                <MudPaper Class="pa-3 ma-2" Elevation="0">
                    <MudText Typo="Typo.h5">Offers</MudText>
                    <ItemsList ItemService="OrderOffersService">
                        <OfferCard Model="@context" />
                    </ItemsList>
                </MudPaper>
            }
            @if (UserIsClient())
            {
                @if (_orderModel.ContractorUid is not null)
                {
                    <MudPaper Class="pa-3 ma-2" Elevation="0">
                        <MudText Typo="Typo.h5">Results</MudText>
                        <ItemsList ItemService="ResultsService">
                            <ResultCard Model="@context" />
                        </ItemsList>
                    </MudPaper>

                    @if (_orderModel.Status != OrderStatus.Done)
                    {
                        <MudPaper Class="pa-3 ma-2" Elevation="0">
                            <MudGrid Justify="Justify.SpaceBetween">
                                <MudButton OnClick="AcceptResultAsync" Color="Color.Success">Accept result</MudButton>
                                <MudButton OnClick="DeclineResultAsync" Color="Color.Error">Decline result</MudButton>
                                <MudButton OnClick="DeclineContractorAsync" Color="Color.Error">Decline contractor</MudButton>
                            </MudGrid>
                        </MudPaper>
                    }
                }
            }
            else
            {
                <MudButton Color="Color.Primary" Href="@($"/add_offer/{_orderModel.Uid}")">Add offer</MudButton>
            }
        </MudContainer>

    </MudCard>
}

@code {
    [Parameter]
    public string OrderUid { get; set; }

    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; }

    private Guid _orderUid;
    private ClaimsPrincipal User;
    private OrderDetailsModel _orderModel;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        User = authState.User;

        _orderUid = Guid.Parse(OrderUid);
        OrderOffersService.OrderUid = _orderUid;
        ResultsService.ContractUid = _orderUid;

        await RefreshModel();
    }

    private bool IsCancelable() => UserIsClient() && StatusIsCancelable();

    private bool StatusIsCancelable() => _orderModel.Status == OrderStatus.New || _orderModel.Status == OrderStatus.InProgress;

    private bool UserIsClient() => User.GetUid() == _orderModel.ClientUid;

    private bool IsActionsAvailable() => _orderModel.Status != OrderStatus.Canceled && _orderModel.Status != OrderStatus.Done;

    private async Task RefreshModel()
    {
        try
        {
            _orderModel = await OrderService.GetOrderDetailsAsync(_orderUid);
        }
        catch (Exception e)
        {
            SnackbarService.Add(e.Message);
        }
    }

    private async Task CancelOrderAsync()
    {
        try
        {
            await OrderService.CancelOrderAsync(_orderUid);
            await RefreshModel();
        }
        catch (Exception e)
        {
            SnackbarService.Add(e.Message);
        }
    }

    private async Task AcceptResultAsync()
    {
        try
        {
            await ContractService.AcceptResultAsync(_orderUid);
            await RefreshModel();
        }
        catch (Exception e)
        {
            SnackbarService.Add(e.Message);
        }
    }

    private async Task DeclineResultAsync()
    {
        try
        {
            await ContractService.DeclineResultAsync(_orderUid);
            await RefreshModel();
        }
        catch (Exception e)
        {
            SnackbarService.Add(e.Message);
        }
    }

    private async Task DeclineContractorAsync()
    {
        try
        {
            await ContractService.DeclineContractorAsync(_orderUid);
            await RefreshModel();
        }
        catch (Exception e)
        {
            SnackbarService.Add(e.Message);
        }
    }
}
